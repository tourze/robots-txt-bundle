# RobotsTxt Bundle (中文文档)

[English](README.md) | [中文](README.zh-CN.md)

[![Latest Version](https://img.shields.io/packagist/v/tourze/robots-txt-bundle.svg?style=flat-square)](
https://packagist.org/packages/tourze/robots-txt-bundle)
[![PHP Version](https://img.shields.io/packagist/php-v/tourze/robots-txt-bundle.svg?style=flat-square)](
https://packagist.org/packages/tourze/robots-txt-bundle)
[![Total Downloads](https://img.shields.io/packagist/dt/tourze/robots-txt-bundle.svg?style=flat-square)](
https://packagist.org/packages/tourze/robots-txt-bundle)
[![License](https://img.shields.io/packagist/l/tourze/robots-txt-bundle.svg?style=flat-square)](LICENSE)
[![Build Status](https://img.shields.io/github/actions/workflow/status/tourze/robots-txt-bundle/ci.yml?style=flat-square)](
https://github.com/tourze/robots-txt-bundle/actions)
[![Code Coverage](https://img.shields.io/codecov/c/github/tourze/robots-txt-bundle?style=flat-square)](
https://codecov.io/gh/tourze/robots-txt-bundle)

一个功能完整的 Symfony Bundle，用于动态生成和管理 `robots.txt` 文件，
支持多提供者架构。

## 目录

- [特性](#特性)
- [核心架构](#核心架构)
- [安装](#安装)
- [系统要求](#系统要求)
- [配置](#配置)
- [快速开始](#快速开始)
- [示例输出](#示例输出)
- [使用方法](#使用方法)
  - [基本用法](#基本用法)
  - [创建自定义提供者](#创建自定义提供者)
- [API 参考](#api-参考)
  - [RobotsTxtDirective](#robotstxtdirective)
  - [RobotsTxtRule](#robotstxtrule)
  - [RobotsTxtEntry](#robotstxtentry)
- [高级用法](#高级用法)
  - [动态规则](#动态规则)
  - [条件性提供者](#条件性提供者)
- [测试](#测试)
- [贡献](#贡献)
- [许可证](#许可证)

## 特性

- 🤖 **完整的 robots.txt 支持**：支持所有标准指令
  （User-agent、Allow、Disallow、Crawl-delay、Sitemap等）
- 🔌 **多提供者架构**：通过实现 `RobotsTxtProviderInterface` 
  可以从多个来源收集规则
- 🎯 **优先级控制**：支持提供者优先级，灵活控制规则合并顺序
- 🌍 **环境支持**：可以根据不同环境提供不同的 robots.txt 内容
- ⚡ **性能优化**：内置缓存策略，减少服务器负载
- 📖 **符合规范**：遵循 
  [Google robots.txt 规范](https://developers.google.com/search/docs/crawling-indexing/robots/robots_txt)
- 🔧 **自动配置**：使用 Symfony 的自动配置功能自动注册提供者

## 核心架构

### 数据模型

- **RobotsTxtDirective**: 单个指令（如 `Disallow: /admin/`）
- **RobotsTxtRule**: 针对特定 User-agent 的规则组
- **RobotsTxtEntry**: 完整的 robots.txt 条目

### 提供者系统

- **RobotsTxtProviderInterface**: 核心接口，定义内容提供者
- **DefaultRobotsTxtProvider**: 默认规则提供者

### 服务层

- **RobotsTxtService**: 核心服务，收集和合并所有提供者的内容
- **RobotsTxtController**: 控制器，响应 `/robots.txt` 请求

## 安装

```bash
composer require tourze/robots-txt-bundle
```

## 系统要求

- PHP 8.1 或更高版本
- Symfony 6.4 或更高版本

## 配置

Bundle 开箱即用，只需要最小配置。`/robots.txt` 路由会自动注册，
并从所有已注册的提供者收集内容。

### 自定义配置

如果需要自定义 Bundle 行为，创建配置文件：

```yaml
# config/packages/robots_txt.yaml
robots_txt:
    cache_enabled: true
    cache_ttl: 3600
```

## 快速开始

1. 安装 Bundle
2. 创建自定义提供者
3. 实现 `RobotsTxtProviderInterface`
4. 访问 `/robots.txt`

## 示例输出

```text
# Generated by RobotsTxtBundle

User-agent: *
Disallow: /admin/
Disallow: /private/

User-agent: Googlebot
Allow: /api/public/
Crawl-delay: 1

Sitemap: https://example.com/sitemap.xml
```

## 使用方法

### 基本用法

Bundle 会自动注册 `/robots.txt` 路由，返回生成的 robots.txt 内容。

### 创建自定义提供者

```php
<?php

namespace App\Provider;

use Tourze\RobotsTxtBundle\Provider\RobotsTxtProviderInterface;
use Tourze\RobotsTxtBundle\Model\RobotsTxtEntry;
use Tourze\RobotsTxtBundle\Model\RobotsTxtRule;
use Tourze\RobotsTxtBundle\Model\RobotsTxtDirective;

class CustomRobotsTxtProvider implements RobotsTxtProviderInterface
{
    public function provide(): RobotsTxtEntry
    {
        $entry = new RobotsTxtEntry();

        // 添加注释
        $entry = $entry->withComment('自定义 robots.txt 规则');

        // 禁止所有爬虫访问管理区域
        $adminRule = RobotsTxtRule::forAllAgents([
            RobotsTxtDirective::disallow('/admin/'),
            RobotsTxtDirective::disallow('/private/'),
        ]);
        $entry = $entry->withRule($adminRule);

        // 为 Googlebot 设置特殊规则
        $googlebotRule = RobotsTxtRule::forAgent('Googlebot', [
            RobotsTxtDirective::allow('/api/public/'),
            RobotsTxtDirective::crawlDelay(1),
        ]);
        $entry = $entry->withRule($googlebotRule);

        // 添加站点地图
        $entry = $entry->withSitemap('https://example.com/sitemap.xml');

        return $entry;
    }

    public function getPriority(): int
    {
        return 100; // 高优先级
    }

    public function supports(): bool
    {
        // 只在生产环境启用
        return ($_ENV['APP_ENV'] ?? 'prod') === 'prod';
    }
}
```

提供者会自动被注册，无需额外配置。

## API 参考

### RobotsTxtDirective

创建单个 robots.txt 指令：

```php
// Disallow 指令
RobotsTxtDirective::disallow('/admin/');

// Allow 指令
RobotsTxtDirective::allow('/public/');

// Crawl-delay 指令
RobotsTxtDirective::crawlDelay(10);

// Sitemap 指令
RobotsTxtDirective::sitemap('https://example.com/sitemap.xml');

// 自定义指令
new RobotsTxtDirective('Custom-directive', 'value');
```

### RobotsTxtRule

创建针对特定 User-agent 的规则组：

```php
// 针对所有爬虫
RobotsTxtRule::forAllAgents([
    RobotsTxtDirective::disallow('/admin/'),
]);

// 针对特定爬虫
RobotsTxtRule::forAgent('Googlebot', [
    RobotsTxtDirective::allow('/api/'),
    RobotsTxtDirective::crawlDelay(1),
], 100); // 优先级
```

### RobotsTxtEntry

完整的 robots.txt 条目：

```php
$entry = new RobotsTxtEntry();
$entry = $entry->withComment('生成的 robots.txt')
               ->withRule($rule)
               ->withSitemap('https://example.com/sitemap.xml');
```

## 高级用法

### 动态规则

```php
class DynamicRobotsTxtProvider implements RobotsTxtProviderInterface
{
    public function __construct(
        private UserRepository $userRepository
    ) {}

    public function provide(): RobotsTxtEntry
    {
        $entry = new RobotsTxtEntry();
        
        // 根据用户数据动态生成规则
        $users = $this->userRepository->findPublicUsers();
        foreach ($users as $user) {
            $entry = $entry->withRule(
                RobotsTxtRule::forAllAgents([
                    RobotsTxtDirective::allow("/users/{$user->getId()}/")
                ])
            );
        }

        return $entry;
    }
}
```

### 条件性提供者

```php
class ConditionalRobotsTxtProvider implements RobotsTxtProviderInterface
{
    public function supports(): bool
    {
        // 只在特定条件下启用
        return $_ENV['ENABLE_SEO'] === 'true' && 
               $_ENV['APP_ENV'] === 'prod';
    }
}
```

## 测试

```bash
./vendor/bin/phpunit packages/robots-txt-bundle/tests
```

## 贡献

请查看 [CONTRIBUTING.md](../../CONTRIBUTING.md) 了解如何为此项目做出贡献。

## 许可证

MIT License - 查看 [LICENSE](LICENSE) 文件了解详情。

详细文档请参见 [README.md](README.md)。
